{% extends "base.html" %}
{% block content %}
<div class="property-contacts-activity">
    <h2>Contacts</h2>
    <button onclick="showAddContactModal()">Add Contact</button>
    <ul id="contacts-list">
        {% for contact in contacts %}
        <li>
            {{ contact.first_name }} {{ contact.last_name }} ({{ contact.type }})
            <br>Phones: {{ contact.phones|join(', ') }}
        </li>
        {% endfor %}
    </ul>
    <div id="addContactModal" style="display:none;">
        <form id="addContactForm">
            <input name="first_name" placeholder="First Name" required><br>
            <input name="last_name" placeholder="Last Name" required><br>
            <input name="type" placeholder="Type (e.g. Owner, Tenant)" required><br>
            <button type="submit">Add Contact</button>
            <button type="button" onclick="hideAddContactModal()">Cancel</button>
        </form>
    </div>
    <h2>Phones</h2>
    <button onclick="showAddPhoneModal()">Add Phone</button>
    <ul id="phones-list">
        {% for phone in phones %}
        <li>{{ phone.phone }}</li>
        {% endfor %}
    </ul>
    <div id="addPhoneModal" style="display:none;">
        <form id="addPhoneForm">
            <input name="phone" placeholder="Phone Number" required><br>
            <button type="submit">Add Phone</button>
            <button type="button" onclick="hideAddPhoneModal()">Cancel</button>
        </form>
    </div>
    <h2>Activity Log</h2>
    <ul id="activity-log-list">
        {% for log in activity_log %}
        <li>{{ log.timestamp }} - <strong>{{ log.activity_type }}</strong>: {{ log.details }} ({{ log.user }})</li>
        {% endfor %}
    </ul>
    <form id="addActivityLogForm">
        <input name="activity_type" placeholder="Type (e.g. Note, Edit)" required><br>
        <input name="details" placeholder="Details" required><br>
        <input name="user" placeholder="User" required><br>
        <button type="submit">Add Log</button>
    </form>
</div>
<script>
function showAddContactModal() {
    document.getElementById('addContactModal').style.display = 'block';
}
function hideAddContactModal() {
    document.getElementById('addContactModal').style.display = 'none';
}
document.getElementById('addContactForm').onsubmit = function(e) {
    e.preventDefault();
    const form = e.target;
    const data = {
        first_name: form.first_name.value,
        last_name: form.last_name.value,
        type: form.type.value
    };
    fetch('/contacts/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    }).then(r => r.json()).then(res => {
        if(res.success) {
            location.reload();
        }
    });
};
function showAddPhoneModal() {
    document.getElementById('addPhoneModal').style.display = 'block';
}
function hideAddPhoneModal() {
    document.getElementById('addPhoneModal').style.display = 'none';
}
document.getElementById('addPhoneForm').onsubmit = function(e) {
    e.preventDefault();
    const form = e.target;
    const data = {
        phone: form.phone.value
    };
    fetch('/phones/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    }).then(r => r.json()).then(res => {
        if(res.success) {
            location.reload();
        }
    });
};
document.getElementById('addActivityLogForm').onsubmit = function(e) {
    e.preventDefault();
    const form = e.target;
    const data = {
        property_id: {{ property.id }},
        activity_type: form.activity_type.value,
        details: form.details.value,
        user: form.user.value
    };
    fetch('/property_activity_log/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    }).then(r => r.json()).then(res => {
        if(res.success) {
            fetch(`/api/property_activity_log?property_id=${data.property_id}`)
                .then(r => r.json())
                .then(logs => {
                    const ul = document.getElementById('activity-log-list');
                    ul.innerHTML = '';
                    logs.forEach(log => {
                        const li = document.createElement('li');
                        li.innerHTML = `${log.timestamp} - <strong>${log.activity_type}</strong>: ${log.details} (${log.user})`;
                        ul.appendChild(li);
                    });
                });
            form.reset();
        }
    });
};
</script>
{% endblock %}
