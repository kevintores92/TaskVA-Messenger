{% extends "base.html" %}
{% block content %}

<div id="container-3col">
  <!-- LEFT PANEL -->
  <div id="left" class="mobile-hidden">
    <!-- Thread Count + Bulk Actions -->
    <!-- Mission Control Header -->
    <div id="filter-bar" class="sticky-section search-bar">
      <button id="refreshBtn" class="icon-btn" onclick="reloadThreads()" title="Refresh">
        <svg xmlns="http://www.w3.org/2000/svg" 
            width="16" height="16" fill="currentColor" 
            viewBox="0 0 16 16">
          <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
          <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966a.25.25 0 0 1 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
        </svg>
      </button>
      <button id="inboxBtn" onclick="setBoxFilter('inbox')">Inbox</button>
      <button id="unreadBtn" onclick="setBoxFilter('unread')">Unread</button>
      <button id="sentBtn" onclick="setBoxFilter('sent')">Sent</button>
      <button id="allBtn" onclick="setBoxFilter('all')">All</button>
      <span class="tag-filter-dropdown">
        <button class="tag-filter-toggle">Filter Tags ‚è∑</button>
        <div class="tag-filter-menu">
          <div class="apply-tags">‚úî Apply</div>
          <div class="tag-option" data-value="__ALL__">All tags</div>
          <div class="tag-option" data-value="__NO_tag__">No tag</div>
          {% for tag in tags %}
            <div class="tag-option" data-value="{{ tag }}">{{ tag }}</div>
          {% endfor %}
        </div>
      </span>
      <div class="search-wrapper">
        <input type="text" id="search" placeholder="Search...">
        <span id="clear-search" class="clear-btn">&times;</span>
      </div>
      <span id="threadCount">{{ threads|length }} msgs</span>
      {% if box != 'inbox' %}
      <span class="mission-control-header">
      <ul class="mission-control">
        <li onclick="setBoxFilter('unread')" title="Unread">
          <div class="square-icon-box">üì©</div>
          <div class="mission-callout">{{ unread_count }}</div>
        </li>
        <li onclick="setBoxFilter('unanswered')" title="Unanswered">
          <div class="square-icon-box">‚è≥</div>
          <div class="mission-callout">{{ unanswered_count }}</div>
        </li>
        <li onclick="setBoxFilter('reminders')" title="Reminders">
          <div class="square-icon-box">‚è∞</div>
          <div class="mission-callout">{{ reminders_count }}</div>
        </li>
        <li onclick="setBoxFilter('no-tags')" title="No Tags">
          <div class="square-icon-box">üè∑Ô∏è</div>
          <div class="mission-callout">{{ no_tags_count }}</div>
        </li>
      </ul>
    </span>
    <div style="text-align:right; margin:10px 20px 0 0;">
      <a href="/logout" style="color:#007bff; font-weight:bold; text-decoration:none;">Logout</a>
    </div>
      {% endif %}
    </div>
    <!-- Threads List -->
    <div id="thread-list-inner">
      {% include "_threads.html" %}
    </div>
  </div>

  <script>
  let currentPage = 1;
  let loadingThreads = false;
  let lastPageReached = false;

  function appendThreads(threads) {
    const container = document.getElementById('thread-list-inner');
    threads.forEach(thread => {
      // Basic rendering, adjust as needed for your thread HTML
      const div = document.createElement('div');
      div.className = 'thread card';
      div.id = `thread-${thread.phone.replace('+','plus')}`;
      div.innerHTML = `
        <div class="thread-info">
          <div class="thread-name">
            <b class="thread-name-label">${thread.name || thread.phone}</b>
            <span class="thread-phone" style="display:none;">${thread.phone}</span>
            ${thread.unread ? '<span class="unread-badge" style="color:red; margin-left:6px;">‚óè</span>' : ''}
          </div>
          <div class="thread-preview thread-body">${thread.latest}</div>
        </div>
        <div class="thread-actions">
          <div class="thread-time">${thread.timestamp}</div>
        </div>
      `;
      div.onclick = function(e) {
        if (!e.target.closest('.thread-tag-wrapper')) loadThread(thread.phone);
      };
      container.appendChild(div);
    });
  }

  function fetchMoreThreads() {
    if (loadingThreads || lastPageReached) return;
    loadingThreads = true;
    currentPage++;
    fetch(`/api/threads?page=${currentPage}`)
      .then(res => res.json())
      .then(data => {
        if (data.threads && data.threads.length > 0) {
          appendThreads(data.threads);
        } else {
          lastPageReached = true;
        }
        loadingThreads = false;
      })
      .catch(() => { loadingThreads = false; });
  }

  document.getElementById('thread-list-inner').addEventListener('scroll', function() {
    const el = this;
    if (el.scrollTop + el.clientHeight >= el.scrollHeight - 50) {
      fetchMoreThreads();
    }
  });
  </script>
  <style>
    .thread-actions .mark-read-btn, .thread-actions .call-btn {
      display: none;
      margin-right: 6px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
    }
    .thread.card:hover .thread-actions .mark-read-btn,
    .thread.card:hover .thread-actions .call-btn {
      display: inline-block;
    }
    .thread.card .thread-actions .call-btn {
      margin-left: 4px;
    }
  </style>
  <script>
  function toggleReadStatus(btn) {
    const phone = btn.getAttribute('data-phone');
    const unread = btn.getAttribute('data-unread') === '1';
    fetch('/api/thread/read', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phone: phone, read: unread ? true : false })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        // Toggle icon
        btn.setAttribute('data-unread', unread ? '0' : '1');
        btn.querySelector('img').src = '/static/' + (unread ? 'icon-envelope-open.png' : 'icon-envelope.png');
        // Toggle unread badge
        const threadDiv = btn.closest('.thread.card');
        const unreadBadge = threadDiv.querySelector('.unread-badge');
        if (unreadBadge) {
          if (unread) unreadBadge.remove();
        } else {
          if (!unread) {
            const badge = document.createElement('span');
            badge.className = 'unread-badge';
            badge.style = 'color:red; margin-left:6px;';
            badge.textContent = '‚óè';
            threadDiv.querySelector('.thread-name-label').after(badge);
          }
        }
      }
    });
  }

  // Mark thread as read when opened
  function loadThread(phone) {
    fetch('/api/thread/read', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phone: phone, read: true })
    });
    // ...existing loadThread logic...
  }
  </script>

  <!-- CENTER PANEL -->
  <div id="center" class="center-panel">
    <div id="contact-meta-top" class="contact-section-header">
      <h2 id="contact-name" class="thread-name">Select a conversation</h2>
      <b class="thread-name-label" id="contact-thread-label"></b>
      <div id="tag-menu">
        <div id="tag-chips"></div>
      </div>
    </div>

    <div class="conversation-wrapper">
      <div id="messages" class="messages">
        {% for msg in messages %}
          <div class="message {% if msg.inbound %}inbound{% else %}outbound{% endif %}">              
            <div class="message-content">
              <div class="bubble">{{ msg.text }}</div>
              <div class="message-meta">
                <div class="timestamp">{{ msg.timestamp }}</div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
    <hr />

    <div id="send-section" class="send-section">
      <textarea id="msgBody" rows="1" placeholder="Type your message..."></textarea>
      <button class="btn btn-primary" onclick="sendMsg()">Send</button>
    </div>
  </div>
  
  <!-- RIGHT PANEL -->
  <div id="right-panel" class="mobile-hidden">
  <div id="contact-extra"><!-- populated by loadThread; edit form will be injected here --></div>
    <div id="notes-panel" class="meta-section">
      <textarea id="notes" rows="5" placeholder="Notes..."></textarea>
    </div>
  </div>

<div id="dripPopup" style="display:none;"></div>

{% endblock %}
