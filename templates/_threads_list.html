{% for thread in threads %}
  <div class="thread card{% if selected_phone == thread.phone %} selected{% endif %}" 
       id="thread-{{ thread.phone | replace('+','plus') }}" 
       onclick="if(!event.target.closest('.thread-tag-wrapper')) loadThread('{{ thread.phone }}')">

    <div class="thread-info">
      <div class="thread-name">
        <b class="thread-name-label">
          {% if thread.name %}{{ thread.name }}{% else %}{{ thread.phone }}{% endif %}
        </b>
        <span class="thread-phone" style="display:none;">{{ thread.phone }}</span>

        {# --- 🔴 Unread indicator --- #}
        {% if thread.unread %}
          <span class="unread-badge" style="color:red; margin-left:6px;">●</span>
        {% endif %}

        <span class="thread-tag-wrapper">
          {# Show only one Drip chip for any Drip tag #}
          {% set drip_name = None %}
          {% if thread.tag and thread.tag.startswith('Drip - ') %}
            {% set drip_name = thread.tag[7:] %}
          {% endif %}
          <span class="chip drip-chip"
                data-phone="{{ thread.phone }}"
                data-tag="{{ thread.tag or 'No tag' }}"
                {% if drip_name %}data-tooltip="{{ drip_name }}" title="{{ drip_name }}"{% else %}title="{{ thread.tag or 'No tag' }}"{% endif %}>
            {% if thread.tag == 'Drip' or (thread.tag and thread.tag.startswith('Drip')) %}💧{% elif thread.tag == 'Wrong Number' %}❗{% elif thread.tag == 'Not interested' %}❌{% else %}{{ tag_icons.get(thread.tag or 'No tag', '🏷️') }}{% endif %}
          </span>
          <span class="tag-menu">
            {% for tag in tags %}
              <span class="tag-option"
                    data-tag="{{ tag }}"
                    title="{{ tag }}"
                    onclick="assignTagToThread('{{ thread.phone }}', '{{ tag }}')"
                    style="cursor:pointer;">
                {% if tag == 'Wrong Number' %}❗{% elif tag == 'Not interested' %}❌{% else %}{{ tag_icons.get(tag, '🏷️') }}{% endif %}
              </span>
            {% endfor %}
          </span>

        {% if thread.notes and thread.notes|trim %}
          <span class="note-icon">&#128221;
            <span class="note-tooltip">{{ thread.notes }}</span>
          </span>
        {% endif %}
        
      </div>
      <div class="thread-preview thread-body">{{ thread.latest | replace('\n', '<br>') | safe }}</div>
    </div>

    <div class="thread-actions">
        <div class="thread-time">{{ thread.timestamp }}</div>
        <div style="display:flex;align-items:center;">
          <button class="gmail-icon-btn mark-read-btn" data-phone="{{ thread.phone }}" data-unread="{{ thread.unread|int }}" data-tooltip="{{ 'Mark as Unread' if not thread.unread else 'Mark as Read' }}" aria-label="{{ 'Mark as Unread' if not thread.unread else 'Mark as Read' }}" onclick="event.stopPropagation(); toggleReadStatus(this)">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
              {% if thread.unread %}
                <!-- Envelope closed (unread) -->
                <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5-8-5V6l8 5 8-5v2z"/>
              {% else %}
                <!-- Envelope open (read) -->
                <path d="M4 8l8 5 8-5v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V8zm8-6L4 8l8 5 8-5-8-6z"/>
              {% endif %}
            </svg>
          </button>
          <button class="btn btn-sm call-btn" onclick="event.stopPropagation(); callContact('{{ thread.phone }}')" style="display:none;">📞</button>
          <input type="checkbox" class="thread-checkbox" data-phone="{{ thread.phone }}" onclick="event.stopPropagation();">
        </div>
    </div>
  </div>
{% endfor %}
