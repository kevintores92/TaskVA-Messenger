{% for thread in threads %}
  <div class="thread card{% if selected_phone == thread.phone %} selected{% endif %}" 
       id="thread-{{ thread.phone | replace('+','plus') }}" 
       onclick="if(!event.target.closest('.thread-tag-wrapper')) loadThread('{{ thread.phone }}')">

    <div class="thread-info">
      <div class="thread-name" style="display: flex; align-items: center; justify-content: space-between; width: 100%; line-height: 1.1; flex-wrap: wrap; height: auto; min-height: unset; max-height: unset;">
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
          <b class="thread-name-label" style="font-size:1.08em;line-height:1.1;">
            {% if thread.name %}{{ thread.name }}{% else %}{{ thread.phone }}{% endif %}
          </b>
          <span class="contact-extra" style="color:#888;font-size:0.95em;">{{ thread.contact_extra or '' }}</span>
          {% if thread.unread %}
            <span class="unread-badge" style="color:red; margin-left:6px;">â—</span>
          {% endif %}
          <span class="thread-tag-wrapper">
            {% set drip_name = None %}
            {% if thread.tag and thread.tag.startswith('Drip - ') %}
              {% set drip_name = thread.tag[7:] %}
            {% endif %}
            <span class="chip drip-chip"
                  data-phone="{{ thread.phone }}"
                  data-tag="{{ thread.tag or 'No tag' }}"
                  {% if drip_name %}data-tooltip="{{ drip_name }}" title="{{ drip_name }}"{% else %}title="{{ thread.tag or 'No tag' }}"{% endif %}>
              {% if thread.tag == 'Drip' or (thread.tag and thread.tag.startswith('Drip')) %}ğŸ’§
              {% elif thread.tag == 'Wrong Number' %}â—
              {% elif thread.tag == 'Not interested' %}âŒ
              {% else %}{{ tag_icons.get(thread.tag or 'No tag', 'ğŸ·ï¸') }}
              {% endif %}
            </span>
            <span class="tag-menu">
              {% for tag in tags %}
                <span class="tag-option"
                      data-tag="{{ tag }}"
                      title="{{ tag }}"
                      onclick="assignTagToThread('{{ thread.phone }}', '{{ tag }}')"
                      style="cursor:pointer;">
                  {% if tag == 'Wrong Number' %}â—
                  {% elif tag == 'Not interested' %}âŒ
                  {% else %}{{ tag_icons.get(tag, 'ğŸ·ï¸') }}
                  {% endif %}
                </span>
              {% endfor %}
            </span>
            {% if thread.notes and thread.notes|trim %}
              <span class="note-icon">&#128221;
                <span class="note-tooltip">{{ thread.notes }}</span>
              </span>
            {% endif %}
          </span>
        </div>
      </div>
      <div class="thread-preview thread-body">{{ thread.latest | replace('\n', '<br>') | safe }}</div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;">
      <div class="thread-time" style="margin-bottom:4px; text-align:right; min-width:80px; color:#607d8b; font-size:0.85em;">
        {% set ts = thread.timestamp %}
        {% if ts %}
  <div class="thread-time" data-raw-timestamp="{{ thread.timestamp }}">{{ thread.timestamp if thread.timestamp else '' }}</div>
        {% endif %}
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <button class="gmail-icon-btn mark-read-btn" data-phone="{{ thread.phone }}" data-unread="{{ thread.unread|int }}" title="{{ 'Mark as Unread' if not thread.unread else 'Mark as Read' }}" aria-label="{{ 'Mark as Unread' if not thread.unread else 'Mark as Read' }}" onclick="event.stopPropagation(); toggleReadStatus(this)">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
            {% if thread.unread %}
              <!-- Envelope closed (unread) -->
              <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5-8-5V6l8 5 8-5v2z"/>
            {% else %}
              <!-- Envelope open (read) -->
              <path d="M4 8l8 5 8-5v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V8zm8-6L4 8l8 5 8-5-8-6z"/>
            {% endif %}
          </svg>
        </button>
        <button class="btn btn-sm call-btn" onclick="event.stopPropagation(); callContact('{{ thread.phone }}')">ğŸ“</button>
        <button class="btn btn-sm reminder-btn" onclick="event.stopPropagation(); openReminderPopup(event, '{{ thread.phone }}')" title="Set Reminder">â°</button>
      </div>
      <script>
        function toggleReadStatus(btn) {
          const phone = btn.getAttribute('data-phone');
          const unread = btn.getAttribute('data-unread') === '1';
          fetch('/api/thread/read', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone: phone, read: !unread })
          }).then(r => r.json()).then(res => {
            if (res.success) {
              btn.setAttribute('data-unread', unread ? '0' : '1');
              btn.title = unread ? 'Mark as Read' : 'Mark as Unread';
              btn.ariaLabel = btn.title;
              // Optionally update UI
              if (typeof reloadThreads === 'function') reloadThreads();
              if (window.currentPhone === phone && typeof loadThread === 'function') loadThread(phone);
            }
          });
        }
      </script>
    </div>
  </div>
{% endfor %}
