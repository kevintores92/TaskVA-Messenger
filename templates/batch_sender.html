{% extends "base.html" %}
{% block content %}
<main class="shifted p-4 lg:p-6">
  <div class="max-w-4xl bg-white shadow rounded-lg batch-card p-6 mx-auto">
    <h1 class="text-2xl font-bold text-gray-800 mb-6">Batch SMS Sender</h1>

    <!-- Form -->
    <form method="post" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Max Messages</label>
        <input type="number" name="max_texts" value="200"
               class="w-full border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500">
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Min Interval (sec)</label>
          <input type="number" step="0.01" name="min_interval" value="5.01"
                 class="w-full border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Max Interval (sec)</label>
          <input type="number" step="0.01" name="max_interval" value="9.99"
                 class="w-full border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
      </div>

      <button type="submit"
              class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">
        Start Batch
      </button>

      <button type="button" id="stop-batch"
              class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition mt-2">
        Stop Batch
      </button>
    </form>

    <!-- Progress -->
    <div class="mt-6">
      <progress id="progress" value="0" max="100" class="w-full h-4"></progress>
      <p id="counter" class="mt-2 text-gray-600 text-sm">Idle</p>
    </div>

    <!-- Batch Log Table -->
    <!-- Batch Log + Load History button -->
<div class="mt-10">
  <h2 class="text-xl font-semibold text-gray-800 mb-4">Batch Log</h2>

  <!-- Big centered Load History button (shows first 50 newest rows) -->
  <div id="load-history-container" class="flex justify-center items-center py-8">
    <button id="load-history-btn"
      class="px-8 py-4 bg-blue-600 text-white font-bold text-lg rounded-xl shadow-lg hover:bg-blue-700 transition"
      title="Load the 50 newest history rows">
      Load History (50 newest)
    </button>
  </div>

  <!-- Table (starts empty until you click Load History or a batch finishes / Stop is pressed) -->
  <div class="overflow-x-auto">
    <table class="batch-table w-full min-w-[600px]" id="batch-table">
      <thead>
        <tr>
          <th>Batch</th>
          <th>Name</th>
          <th>Phone</th>
          <th>Address</th>
          <th>Status</th>
          <th>Message Used</th>
          <th>Timestamp</th>
        </tr>
      </thead>



      <tbody id="batch-body">
        <!-- rows will be injected here after pressing Load History -->
      </tbody>
    </table>
  </div>
</div>


<style>
  .batch-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }

  progress { -webkit-appearance: none; appearance: none; border-radius: 9999px; overflow: hidden; background-color: #f3f4f6; }
  progress::-webkit-progress-bar { background-color: #f3f4f6; border-radius: 9999px; }
  progress::-webkit-progress-value { background-color: #2563eb; border-radius: 9999px; transition: width 0.5s ease; }
  progress::-moz-progress-bar { background-color: #2563eb; border-radius: 9999px; }

  input:focus { outline: none !important; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3); }
  button:active { transform: scale(0.98); }

  .batch-table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
  .batch-table th, .batch-table td { padding: 0.5rem 0.75rem; border-bottom: 1px solid #e5e7eb; text-align: left; }
  .batch-table th { background: #f9fafb; font-weight: 600; }
  .batch-table tr:nth-child(even) { background: #f9fafb; }

</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  let currentPage = 1;
  const perPage = 50;
  let loading = false;
  let allLoaded = false;

  const tbody = document.getElementById('batch-body');
  const loadBtn = document.getElementById('load-history-btn');
  const loadContainer = document.getElementById('load-history-container');

  // --- render function ---
  async function loadBatchLogs(reset = false) {
    if (loading) return;
    if (allLoaded && !reset) return;

    loading = true;

    const res = await fetch(`/batch-logs?page=${currentPage}&per_page=${perPage}`);
    if (!res.ok) {
      console.error('Failed to load batch logs', res.status);
      loading = false;
      return;
    }

    const data = await res.json();
    if (reset) {
      tbody.innerHTML = '';
      currentPage = 1;
      allLoaded = false;
    }

    data.rows.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.Batch || ""}</td>
        <td>${row.Name || ""}</td>
        <td>${row.Phone || ""}</td>
        <td>${row.Address || ""}</td>
        <td>${row.Status || ""}</td>
        <td>${row["Message Used"] || ""}</td>
        <td>${row.timestamp || ""}</td>
      `;

      tbody.appendChild(tr);
    });

    if ((currentPage * perPage) >= data.total) {
      allLoaded = true;
    } else {
      currentPage++;
    }

    loading = false;
  }

  // --- infinite scroll ---
  window.addEventListener("scroll", () => {
    if (!allLoaded && (window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
      loadBatchLogs();
    }
  });

  // --- Load History button ---
  if (loadBtn) {
    loadBtn.addEventListener('click', async () => {
      await loadBatchLogs(true);      // load first 50
      if (loadContainer) loadContainer.style.display = 'none';  // hide button
    });
  }

  // --- progress updater ---
  async function updateProgress() {
    const res = await fetch('/batch-progress');
    if (!res.ok) return;
    const data = await res.json();

    if (data.total > 0) {
      document.getElementById('progress').value = (data.sent / data.total) * 100;
      document.getElementById('counter').innerText = `Sending ${data.sent} of ${data.total}`;
    }

    if (data.running) {
      setTimeout(updateProgress, 1000);
    } else if (data.total > 0) {
      document.getElementById('counter').innerText = 'Done!';
      // reload history after a batch completes
      currentPage = 1;
      allLoaded = false;
      await loadBatchLogs(true);
      if (loadContainer) loadContainer.style.display = 'none';
    }
  }

  // --- Stop button handler ---
  const stopBtn = document.getElementById('stop-batch');
  if (stopBtn) {
    stopBtn.addEventListener('click', async () => {
      await fetch('/stop-batch', { method: 'POST' });
      document.getElementById('counter').innerText = 'Stopped!';
      currentPage = 1;
      allLoaded = false;
      await loadBatchLogs(true);
      if (loadContainer) loadContainer.style.display = 'none';
    });
  }

  // start progress updater right away
  updateProgress();
});
</script>


{% endblock %}
