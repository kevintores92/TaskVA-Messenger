<!-- Reminder Popup (moved below for clarity) -->
{% block reminder_popup %}
<div id="reminderPopup" class="modal-popup" style="display:none;">
  <div class="modal-overlay" onclick="closeReminderPopup(event)"></div>
  <div class="modal-content">
    <button class="modal-close" onclick="closeReminderPopup(event)">&times;</button>
    <h3>‚è∞ Set Reminder</h3>
    <form id="reminderForm">
      <label>Date:</label>
      <input type="date" name="reminder_date" required><br>
      <label>Time:</label>
      <input type="time" name="reminder_time" required><br>
      <label>Notes:</label>
      <textarea name="reminder_notes" rows="2"></textarea><br>
      <label>SMS to Send:</label>
      <textarea name="reminder_sms" rows="2" placeholder="Type SMS to send..."></textarea><br>
      <input type="hidden" name="reminder_phone" id="reminderPhone">
      <button type="submit" class="btn btn-primary">Save Reminder</button>
    </form>
  </div>
</div>
{% endblock %}
<script>
function openReminderPopup(e, phone) {
  e.stopPropagation();
  document.getElementById('reminderPopup').style.display = 'block';
  document.getElementById('reminderPhone').value = phone;
}
function closeReminderPopup(e) {
  if (!e || e.target.classList.contains('modal-overlay') || e.target.classList.contains('modal-close')) {
    document.getElementById('reminderPopup').style.display = 'none';
  }
}
document.getElementById('reminderForm').addEventListener('submit', function(ev) {
  ev.preventDefault();
  const form = ev.target;
  const data = {
    phone: form.reminder_phone.value,
    date: form.reminder_date.value,
    time: form.reminder_time.value,
    notes: form.reminder_notes.value,
    sms: form.reminder_sms.value
  };
  fetch('/api/reminder', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  }).then(res => res.json()).then(resp => {
    if (resp.success) {
      alert('Reminder saved!');
      closeReminderPopup();
    } else {
      alert('Failed to save reminder.');
    }
  });
});
</script>
{% extends "base.html" %}
{% block content %}

<div id="container-3col">
  <!-- LEFT PANEL -->
  <div id="left" class="mobile-hidden">
    <!-- Thread Count + Bulk Actions -->
    <!-- Mission Control Header -->
    <div id="filter-bar" class="sticky-section search-bar">
      <button id="refreshBtn" class="icon-btn" onclick="reloadThreads()" title="Refresh">
        <svg xmlns="http://www.w3.org/2000/svg" 
          width="16" height="16" fill="currentColor" 
          viewBox="0 0 16 16">
          <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
          <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966a.25.25 0 0 1 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
        </svg>
      </button>
      <button id="inboxBtn" onclick="setBoxFilter('inbox')">Inbox</button>
      <button id="unreadBtn" onclick="setBoxFilter('unread')">Unread</button>
      <button id="sentBtn" onclick="setBoxFilter('sent')">Sent</button>
      <button id="allBtn" onclick="setBoxFilter('all')">All</button>
      <span class="tag-filter-dropdown">
        <button class="tag-filter-toggle">Filter Tags ‚è∑</button>
        <div class="tag-filter-menu">
          <div class="apply-tags">‚úî Apply</div>
          <div class="tag-option" data-value="__ALL__">All tags</div>
          <div class="tag-option" data-value="__NO_tag__">No tag</div>
          {% for tag in tags %}
            <div class="tag-option" data-value="{{ tag }}">{{ tag }}</div>
          {% endfor %}
        </div>
      </span>
      <div class="search-wrapper">
        <input type="text" id="search" placeholder="Search...">
        <span id="clear-search" class="clear-btn">&times;</span>
      </div>
        <div class="pagination-controls" style="position:static;display:inline-flex;align-items:center;margin-left:12px">
          {% set start_idx = ((page - 1) * page_size) + 1 %}
          {% set end_idx = start_idx + threads|length - 1 %}
          <span>{{ start_idx }}-{{ end_idx }} of {{ total_threads }}</span>
          <button {% if page <= 1 %}disabled{% endif %} onclick="window.location='?page={{ page - 1 }}'" style="margin:0 8px">&#60;</button>
          <button {% if end_idx >= total_threads %}disabled{% endif %} onclick="window.location='?page={{ page + 1 }}'">&#62;</button>
        </div>
      {% if box != 'inbox' %}
      <span class="mission-control-header">
        <ul class="mission-control">
          <li onclick="setBoxFilter('unread')" title="Unread">
            <div class="square-icon-box">üì©</div>
            <div class="mission-callout">{{ unread_count }}</div>
          </li>
          <li onclick="setBoxFilter('reminders')" title="Reminders">
            <div class="square-icon-box">‚è∞</div>
            <div class="mission-callout">{{ reminders_count }}</div>
          </li>
        </ul>
      </span>
      <span id="threadCount">{{ threads|length }} msgs</span>
      {% endif %}
    </div>
    <!-- Threads List -->
    <div id="thread-list-inner">
      {% include "_threads.html" %}
    </div>
  </div>
  <script>
  fetch('/api/thread/read', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ phone: phone, read: unread ? true : false })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      // Toggle icon
      btn.setAttribute('data-unread', unread ? '0' : '1');
      btn.querySelector('img').src = '/static/' + (unread ? 'icon-envelope-open.png' : 'icon-envelope.png');
      // Toggle unread badge
      const threadDiv = btn.closest('.thread.card');
      const unreadBadge = threadDiv.querySelector('.unread-badge');
      if (unreadBadge) {
        if (unread) unreadBadge.remove();
      } else {
        if (!unread) {
          const badge = document.createElement('span');
          badge.className = 'unread-badge';
          badge.style = 'color:red; margin-left:6px;';
          badge.textContent = '‚óè';
          threadDiv.querySelector('.thread-name-label').after(badge);
        }
      }
    }
  });
  }
  // Mark thread as read when opened
  function loadThread(phone) {
    fetch('/api/thread/read', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phone: phone, read: true })
    });
    // Fetch thread details and update right panel
    fetch(`/thread/${phone}`)
      .then(res => res.json())
      .then(data => {
        // Update contact name and thread label
        document.getElementById('contact-name').textContent = data.name || phone;
        document.getElementById('contact-thread-label').textContent = phone;
        // Update tag chips
        document.getElementById('tag-chips').textContent = data.tag || '';
        // Update notes
        document.getElementById('notes').value = data.notes || '';
        // Update contact extra info
        let extra = '';
        if (data.contact_extra) extra += data.contact_extra;
        if (data.contact && data.contact.property_details) extra += ' ' + data.contact.property_details;
        document.getElementById('contact-extra').textContent = extra.trim();
      });
  }

  // Format timestamps as 'Sep 10' in thread list and messages
  function formatTimestamp(ts) {
    if (!ts) return '';
    let d = new Date(ts.replace(/-/g, '/').split(' ')[0]);
    if (isNaN(d.getTime())) return ts;
    const month = d.toLocaleString('en-US', { month: 'short' });
    const day = d.getDate();
    return `${month} ${day}`;
  }
  function updateTimestamps() {
    document.querySelectorAll('.thread-time[data-raw-timestamp]').forEach(el => {
      el.textContent = formatTimestamp(el.getAttribute('data-raw-timestamp'));
    });
    document.querySelectorAll('.timestamp[data-raw-timestamp]').forEach(el => {
      el.textContent = formatTimestamp(el.getAttribute('data-raw-timestamp'));
    });
  }
  document.addEventListener('DOMContentLoaded', updateTimestamps);

  </script>

  <!-- CENTER PANEL -->
  <div id="center" class="center-panel">
    <div id="contact-meta-top" class="contact-section-header">
      <h2 id="contact-name" class="thread-name">Select a conversation</h2>
      <b class="thread-name-label" id="contact-thread-label"></b>
      <div id="tag-menu">
        <div id="tag-chips"></div>
      </div>
    </div>

    <div class="conversation-wrapper">
      <div id="messages" class="messages">
        {% for msg in messages %}
        <div class="message {% if msg.inbound %}inbound{% else %}outbound{% endif %}">              
          <div class="message-content">
            <div class="bubble">{{ msg.text }}</div>
            <div class="message-meta">
              <div class="timestamp" data-raw-timestamp="{{ msg.timestamp }}">{{ msg.timestamp if msg.timestamp else '' }}</div>
            </div>
          </div>
        </div>
        <div class="thread-time" data-raw-timestamp="${thread.timestamp}">${thread.timestamp}</div>
        <button class="reminder-btn" onclick="openReminderPopup(event, '${thread.phone}')" title="Set Reminder">‚è∞</button>
        {% endfor %}
      </div>
    </div>
    <hr />

    <div id="send-section" class="send-section">
      <textarea id="msgBody" rows="1" placeholder="Type your message..."></textarea>
      <button class="btn btn-primary" onclick="sendMsg()">Send</button>
    </div>
  </div>
  
  <!-- RIGHT PANEL -->
  <div id="right-panel" class="mobile-hidden">
    <div class="tab-buttons">
      <button id="tab-contact-info" class="tab-btn active" onclick="showContactTab('info')">Contact Info</button>
      <button id="tab-activity-log" class="tab-btn" onclick="showContactTab('activity')">Activity Log</button>
    </div>
    <div id="contact-tab-info" class="tab-panel active">
      <div id="zillow-icon" style="display:flex;align-items:center;justify-content:center;padding:12px 0;"></div>
      <div id="contact-extra"><!-- populated by loadThread; edit form will be injected here --></div>
      <div id="notes-panel" class="meta-section">
        <textarea id="notes" rows="5" placeholder="Notes..."></textarea>
      </div>
    </div>
    <div id="contact-tab-activity" class="tab-panel" style="display:none;">
      <div id="activity-log"><!-- populated by populateActivityLog --></div>
    </div>
  </div>

  <div id="dripPopup" style="display:none;"></div>

</div>
{% endblock %}