{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}

<main class="dashboard-grid-main" style="margin-left: 7%">
  <section class="dashboard-grid-cards" style="margin: 5% 0 16px 0; display: flex; flex-direction: column; gap: 16px;">
  <!-- Week dropdown removed. Showing all-time stats. -->
    <div class="dashboard-grid-kpis">
      <div class="grid-card" style="flex:1; min-width:120px;">
        <b>Total Sent (all time)</b><br>{{ latest.total_sent }}
      </div>
      <div class="grid-card" style="flex:1; min-width:120px;">
        <b>Delivered (all time)</b><br>{{ latest.total_delivered }}
      </div>
      <div class="grid-card" style="flex:1; min-width:120px;">
        <b>Delivery Rate %</b><br>{{ latest.avg_delivery_rate }}
      </div>
      <div class="grid-card" style="flex:1; min-width:120px;">
        <b>Replies (all time)</b><br>{{ latest.total_replies }}
      </div>
      <div class="grid-card" style="flex:1; min-width:120px;">
        <b>Response Rate %</b><br>{{ latest.response_rate }}
      </div>
    </div>
  </section>
  <section class="dashboard-grid-cards">
    <div class="kpi-card">
      <h3 style="margin-bottom: 8px;">Replies Breakdown by Tag</h3>
      <div style="display: flex; align-items: center;justify-content:center;">
        <canvas id="leadBreakdownChart" width="160" height="160" style="max-width:160px;max-height:160px;"></canvas>
        <div style="margin-left: 24px;">
          <div style="margin-bottom: 8px;">
            <span style="display:inline-block;width:14px;height:14px;background:#d77b7b;border-radius:3px;margin-right:8px;"></span>
            Hot: {{ lead_breakdown['Hot'] }}
          </div>
          <div style="margin-bottom: 8px;">
            <span style="display:inline-block;width:14px;height:14px;background:#8bc34a;border-radius:3px;margin-right:8px;"></span>
            Nurture: {{ lead_breakdown['Nurture'] }}
          </div>
          <div style="margin-bottom: 8px;">
            <span style="display:inline-block;width:14px;height:14px;background:#5c6bc0;border-radius:3px;margin-right:8px;"></span>
            Drip: {{ lead_breakdown['Drip'] }}
          </div>
          <div style="margin-bottom: 8px;">
            <span style="display:inline-block;width:14px;height:14px;background:#e0e0e0;border-radius:3px;margin-right:8px;"></span>
            Not interested: {{ lead_breakdown['Not interested'] }}
          </div>
          <div style="margin-bottom: 8px;">
            <span style="display:inline-block;width:14px;height:14px;background:#bdbdbd;border-radius:3px;margin-right:8px;"></span>
            Wrong Number: {{ lead_breakdown['Wrong Number'] }}
          </div>
          <div style="margin-bottom: 8px;">
            <span style="display:inline-block;width:14px;height:14px;background:#bdbdbd;border-radius:3px;margin-right:8px;"></span>
            DNC: {{ lead_breakdown['DNC'] }}
          </div>
          <div style="margin-top:12px;font-weight:bold;">
            Total Tagged Replies: {{ lead_breakdown['total'] }}
          </div>
        </div>
      </div>
    </div>
    <div class="kpi-card" style="grid-column: span 2;">
      <h3 style="margin-bottom: 8px;">Top Campaigns Breakdown</h3>
      <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left;">Campaign</th>
              <th style="text-align:center;">Hot</th>
              <th style="text-align:center;">Nurture</th>
              <th style="text-align:center;">Drip</th>
              <th style="text-align:center;">Not interested</th>
              <th style="text-align:center;">Wrong Number</th>
              <th style="text-align:center;">DNC</th>
              <th style="text-align:center;">Total</th>
            </tr>
          </thead>
          <tbody>
            {% for camp in top_campaigns %}
              <tr style="background:{{ loop.index0 % 2 == 1 and '#f7f8fa' or 'transparent' }};font-size:16px;">
                <td style="padding:8px 0 8px 8px;max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">{{ camp.name }}</td>
                <td style="text-align:center;font-weight:500;">{{ camp.Hot }}</td>
                <td style="text-align:center;font-weight:500;">{{ camp.Nurture }}</td>
                <td style="text-align:center;font-weight:500;">{{ camp.Drip }}</td>
                <td style="text-align:center;font-weight:500;">{{ camp['Not interested'] }}</td>
                <td style="text-align:center;font-weight:500;">{{ camp['Wrong Number'] }}</td>
                <td style="text-align:center;font-weight:500;">{{ camp.DNC }}</td>
                <td style="text-align:center;font-weight:500;">{{ camp.total }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </section>
  <section class="dashboard-grid-charts">
    <div class="chart-card">
      <h3>Messages Sent / Delivered (by day)</h3>
      <canvas id="sentDeliveredChart" width="340" height="180"></canvas>
    </div>
    <div class="chart-card">
      <h3>Delivery Rate % (by day)</h3>
      <canvas id="deliveryRateChart" width="340" height="180"></canvas>
    </div>
    <div class="chart-card">
      <h3>Replies (by day)</h3>
      <canvas id="repliesChart" width="340" height="180"></canvas>
    </div>
    <div class="chart-card">
      <h3>Sent / Replies (last 30 days)</h3>
      <canvas id="lineChart" width="340" height="180"></canvas>
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const dates = {{ dates_7|tojson }};
const sent = {{ sent_7|tojson }};
const delivered = {{ delivered_7|tojson }};
const delivery_rate = {{ delivery_rate_7|tojson }};
const replies = {{ replies_7|tojson }};
const dates30 = {{ dates_30|tojson }};
const sent30 = {{ sent_30|tojson }};
const replies30 = {{ replies_30|tojson }};

// Lead Breakdown Donut
const leadBreakdownData = {
  labels: [
    'Hot Leads',
    'Nurture',
    'Drip',
    'Not interested',
    'Wrong Number',
    'DNC'
  ],
  datasets: [{
    data: [
      {{ lead_breakdown['Hot Leads'] }},
      {{ lead_breakdown['Nurture'] }},
      {{ lead_breakdown['Drip'] }},
      {{ lead_breakdown['Not interested'] }},
      {{ lead_breakdown['Wrong Number'] }},
      {{ lead_breakdown['DNC'] }}
    ],
    backgroundColor: [
      '#d77b7b', // Hot
      '#8bc34a', // Nurture
      '#5c6bc0', // Drip
      '#e0e0e0', // Not interested
      '#e0e0e0', // Wrong Number
      '#bdbdbd'  // DNC
    ],
    borderWidth: 1
  }]
};
new Chart(document.getElementById('leadBreakdownChart'), {
  type: 'doughnut',
  data: leadBreakdownData,
  options: {
    cutout: '70%',
    plugins: {
      legend: { display: false },
      tooltip: { enabled: true }
    }
  }
});

// Sent / Delivered (line)
new Chart(document.getElementById('sentDeliveredChart'), {
  type: 'line',
  data: {
    labels: dates,
    datasets: [
      {
        label: 'Sent',
        data: sent,
        fill: false,
        borderWidth: 2
      },
      {
        label: 'Delivered',
        data: delivered,
        fill: false,
        borderWidth: 2
      }
    ]
  },
  options: { responsive: true, maintainAspectRatio: false, aspectRatio: 1.8 }
});

// Delivery rate (bar)
new Chart(document.getElementById('deliveryRateChart'), {
  type: 'bar',
  data: { labels: dates, datasets: [{ label: 'Delivery Rate %', data: delivery_rate }] },
  options: { responsive: true, maintainAspectRatio: false, aspectRatio: 1.8 }
});

// Replies (bar)
new Chart(document.getElementById('repliesChart'), {
  type: 'bar',
  data: { labels: dates, datasets: [{ label: 'Replies', data: replies }] },
  options: { responsive: true, maintainAspectRatio: false, aspectRatio: 2.2 }
});

// Line chart last 30 days
new Chart(document.getElementById('lineChart'), {
  type: 'line',
  data: { labels: dates30, datasets: [{ label: 'Sent', data: sent30 }, { label: 'Replies', data: replies30 }] },
  options: { responsive: true, maintainAspectRatio: false, aspectRatio: 1.8 }
});
</script>
{% endblock %}
