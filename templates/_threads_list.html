{% for thread in threads %}
  <div class="thread card{% if selected_phone == thread.phone %} selected{% endif %}" 
       id="thread-{{ thread.phone | replace('+','plus') }}" 
       onclick="if(!event.target.closest('.thread-tag-wrapper')) loadThread('{{ thread.phone }}')">

    <div class="thread-info">
      <div class="thread-name" style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
        <div>
          <b class="thread-name-label">
            {% if thread.name %}{{ thread.name }}{% else %}{{ thread.phone }}{% endif %}
          </b>
          <span class="thread-phone" style="display:none;">{{ thread.phone }}</span>
          {% if thread.unread %}
            <span class="unread-badge" style="color:red; margin-left:6px;">●</span>
          {% endif %}
          <span class="thread-tag-wrapper">
            {% set drip_name = None %}
            {% if thread.tag and thread.tag.startswith('Drip - ') %}
              {% set drip_name = thread.tag[7:] %}
            {% endif %}
            {% for thread in threads %}
              <div class="thread card" id="thread-{{ thread.phone|replace('+','plus') }}" onclick="loadThread('{{ thread.phone }}')" onmouseover="showThreadActions(this)" onmouseout="hideThreadActions(this)">
                <div class="thread-info">
                  <div class="thread-name" style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                    <div>
                      <b class="thread-name-label">
                        {% if thread.name %}{{ thread.name }}{% else %}{{ thread.phone }}{% endif %}
                      </b>
                      <span class="thread-phone" style="display:none;">{{ thread.phone }}</span>
                      {% if thread.unread %}
                        <span class="unread-badge" style="color:red; margin-left:6px;">●</span>
                      {% endif %}
                      <span class="thread-tag-wrapper">
                        {% set drip_name = None %}
                        {% if thread.tag and thread.tag.startswith('Drip - ') %}
                          {% set drip_name = thread.tag[7:] %}
                        {% endif %}
                        <span class="chip drip-chip"
                              data-phone="{{ thread.phone }}"
                              data-tag="{{ thread.tag or 'No tag' }}"
                              {% if drip_name %}data-tooltip="{{ drip_name }}" title="{{ drip_name }}"{% else %}title="{{ thread.tag or 'No tag' }}"{% endif %}>
                          {% if thread.tag == 'Drip' or (thread.tag and thread.tag.startswith('Drip')) %}
                              💧
                          {% elif thread.tag == 'Wrong Number' %}
                              ❗
                          {% elif thread.tag == 'Not interested' %}
                              ❌
                          {% else %}{{ tag_icons.get(thread.tag or 'No tag', '🏷️') }}
                          {% endif %}
                        </span>
                        <span class="tag-menu">
                          {% for tag in tags %}
                            <span class="tag-option"
                                  data-tag="{{ tag }}"
                                  title="{{ tag }}"
                                  onclick="assignTagToThread('{{ thread.phone }}', '{{ tag }}')"
                                  style="cursor:pointer;">
                              {% if tag == 'Wrong Number' %}
                              ❗
                              {% elif tag == 'Not interested' %}
                              ❌
                              {% else %}{{ tag_icons.get(tag, '🏷️') }}
                              {% endif %}
                            </span>
                          {% endfor %}
                        </span>
                        {% if thread.notes and thread.notes|trim %}
                          <span class="note-icon">&#128221;
                            <span class="note-tooltip">{{ thread.notes }}</span>
                          </span>
                        {% endif %}
                      </span>
                    </div>
                    <div class="thread-time" style="margin-left:16px; text-align:right; min-width:80px;">
                      {% set ts = thread.timestamp %}
                      {% if ts %}
                        {% set dt = ts.split(' ')[0] %}
                        {% set tm = ts.split(' ')[1] if ' ' in ts else '' %}
                        {% if dt == current_date %}
                          {{ tm[:5] }}
                        {% else %}
                          {{ dt|strftime('%b %d') }}
                        {% endif %}
                      {% endif %}
                    </div>
                  </div>
                  <div class="thread-actions">
                    <div class="thread-time">{{ thread.timestamp }}</div>
                    <button class="call-btn" style="display:none;" onclick="callContact('{{ thread.phone }}');" title="Call">
                      <img src="/static/icon-call.png" alt="Call" />
                    </button>
                    <button class="read-btn" style="display:none;" onclick="toggleReadStatus(this);" data-phone="{{ thread.phone }}" data-unread="{{ thread.unread|int }}" title="Mark as Read/Unread">
                      <img src="/static/icon-envelope.png" alt="Read/Unread" />
                    </button>
                  </div>
                </div>
                <div class="thread-preview thread-body">{{ thread.latest | replace('\n', '<br>') | safe }}</div>
              </div>
            {% endfor %}
            {% endfor %}
