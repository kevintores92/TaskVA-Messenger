{% extends "base.html" %}
{% block content %}

<div id="container-3col">
  <!-- LEFT PANEL -->
  <div id="left" class="mobile-hidden">
    <!-- Thread Count + Bulk Actions -->
    <!-- Mission Control Header -->
    <div id="filter-bar" class="sticky-section search-bar">
      <button id="refreshBtn" class="icon-btn" onclick="reloadThreads()" title="Refresh">
        <svg xmlns="http://www.w3.org/2000/svg" 
            width="16" height="16" fill="currentColor" 
            viewBox="0 0 16 16">
          <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
          <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966a.25.25 0 0 1 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
        </svg>
      </button>
      <button id="inboxBtn" onclick="setBoxFilter('inbox')">Inbox</button>
      <button id="unreadBtn" onclick="setBoxFilter('unread')">Unread</button>
      <button id="sentBtn" onclick="setBoxFilter('sent')">Sent</button>
      <button id="allBtn" onclick="setBoxFilter('all')">All</button>
      <span class="tag-filter-dropdown">
        <button class="tag-filter-toggle">Filter Tags ‚è∑</button>
        <div class="tag-filter-menu">
          <div class="apply-tags">‚úî Apply</div>
          <div class="tag-option" data-value="__ALL__">All tags</div>
          <div class="tag-option" data-value="__NO_tag__">No tag</div>
          {% for tag in tags %}
            <div class="tag-option" data-value="{{ tag }}">{{ tag }}</div>
          {% endfor %}
        </div>
      </span>
      <div class="search-wrapper">
        <input type="text" id="search" placeholder="Search...">
        <span id="clear-search" class="clear-btn">&times;</span>
      </div>
      {% if box != 'inbox' %}
      <span class="mission-control-header">
        <ul class="mission-control">
          <li onclick="setBoxFilter('unread')" title="Unread">
            <div class="square-icon-box">üì©</div>
            <div class="mission-callout">{{ unread_count }}</div>
          </li>
          <li onclick="setBoxFilter('reminders')" title="Reminders">
            <div class="square-icon-box">‚è∞</div>
            <div class="mission-callout">{{ reminders_count }}</div>
          </li>
        </ul>
      </span>
      <span id="threadCount">{{ threads|length }} msgs</span>
        {% endif %}
      </div>
      <!-- Threads List -->
      <div id="thread-list-inner">
        {% include "_threads.html" %}
      </div>
    </div>

  <script>
  let currentPage = 1;
  let loadingThreads = false;
  let lastPageReached = false;

  function appendThreads(threads) {
    const container = document.getElementById('thread-list-inner');
    threads.forEach(thread => {
      // Basic rendering, adjust as needed for your thread HTML
      const div = document.createElement('div');
      div.className = 'thread card';
      div.id = `thread-${thread.phone.replace('+','plus')}`;
      div.innerHTML = `
        <div class="thread-info">
          <div class="thread-name">
            <b class="thread-name-label">${thread.name || thread.phone}</b>
            <span class="thread-phone" style="display:none;">${thread.phone}</span>
            ${thread.unread ? '<span class="unread-badge" style="color:red; margin-left:6px;">‚óè</span>' : ''}
          </div>
          <div class="thread-preview thread-body">${thread.latest}</div>
        </div>
        <div class="thread-actions">
          <div class="thread-time">${thread.timestamp}</div>
        </div>
      `;
      div.onclick = function(e) {
        if (!e.target.closest('.thread-tag-wrapper')) loadThread(thread.phone);
      };
      container.appendChild(div);
    });
  }

  function fetchMoreThreads() {
    if (loadingThreads || lastPageReached) return;
    loadingThreads = true;
    currentPage++;
    fetch(`/api/threads?page=${currentPage}`)
      .then(res => res.json())
      .then(data => {
        if (data.threads && data.threads.length > 0) {
          appendThreads(data.threads);
        } else {
          lastPageReached = true;
        }
        loadingThreads = false;
      })
      .catch(() => { loadingThreads = false; });
  }

  document.getElementById('thread-list-inner').addEventListener('scroll', function() {
    const el = this;
    if (el.scrollTop + el.clientHeight >= el.scrollHeight - 50) {
      fetchMoreThreads();
    }
  });
  

  function toggleReadStatus(btn) {
    const phone = btn.getAttribute('data-phone');
    const unread = btn.getAttribute('data-unread') === '1';
    fetch('/api/thread/read', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phone: phone, read: unread ? true : false })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        // Toggle icon
        btn.setAttribute('data-unread', unread ? '0' : '1');
        btn.querySelector('img').src = '/static/' + (unread ? 'icon-envelope-open.png' : 'icon-envelope.png');
        // Toggle unread badge
        const threadDiv = btn.closest('.thread.card');
        const unreadBadge = threadDiv.querySelector('.unread-badge');
        if (unreadBadge) {
          if (unread) unreadBadge.remove();
        } else {
          if (!unread) {
            const badge = document.createElement('span');
            badge.className = 'unread-badge';
            badge.style = 'color:red; margin-left:6px;';
            badge.textContent = '‚óè';
            threadDiv.querySelector('.thread-name-label').after(badge);
          }
        }
      }
    });
  }

  // Mark thread as read when opened
  function loadThread(phone) {
    fetch('/api/thread/read', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phone: phone, read: true })
    });
    // ...existing loadThread logic...
  }
  </script>

  <!-- CENTER PANEL -->
  <div id="center" class="center-panel">
    <div id="contact-meta-top" class="contact-section-header">
      <div id="contact-address-row" style="margin-bottom:2px;">
        <a id="contact-address-link" href="#" style="font-size:1rem;color:#0074e4;text-decoration:underline;">
          <span id="contact-address">&nbsp;</span>
        </a>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <span id="contact-name" class="thread-name" style="font-size:1rem;font-weight:500;">Select a conversation</span>
        <b class="thread-name-label" id="contact-thread-label" style="font-size:1rem;font-weight:400;margin-left:4px;"></b>
        <div id="tag-menu" style="font-size:0.95rem;display:inline-flex;align-items:center;margin-left:8px;">
          <div id="tag-chips" style="display:inline-flex;gap:4px;"></div>
        </div>
      </div>
    </div>

    <div class="conversation-wrapper">
      <div id="messages" class="messages">
        {% for msg in messages %}
          <div class="message {% if msg.inbound %}inbound{% else %}outbound{% endif %}">              
            <div class="message-content">
              <div class="bubble">{{ msg.text }}</div>
              <div class="message-meta">
                <div class="timestamp">{{ msg.timestamp }}</div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
    <hr />

    <div id="send-section" class="send-section">
      <textarea id="msgBody" rows="1" placeholder="Type your message..."></textarea>
      <button class="btn btn-primary" onclick="sendMsg()">Send</button>
    </div>
  </div>
  
  <!-- RIGHT PANEL -->
  <div id="right-panel" class="mobile-hidden">
    <div class="right-tabs">
      <button class="right-tab-btn active" id="tab-contact-details" onclick="showRightTab('contact-details')">Contact Details</button>
      <button class="right-tab-btn" id="tab-activity-log" onclick="showRightTab('activity-log')">Activity Log</button>
    </div>
    <div id="right-tab-content">
      <div id="right-contact-details" class="right-tab-pane" style="display:block;">
        <div id="zillow-icon" style="display:flex;align-items:center;justify-content:center;padding:12px 0;"></div>
        <div id="contact-extra"><!-- populated by loadThread; edit form will be injected here --></div>
        <div id="notes-panel" class="meta-section">
          <textarea id="notes" rows="5" placeholder="Notes..."></textarea>
        </div>
      </div>
      <div id="right-activity-log" class="right-tab-pane" style="display:none;">
        <div id="activity-log-content" style="padding:12px;">
          <!-- Activity log will be populated here -->
        </div>
      </div>
    </div>
  </div>
<style>
.right-tabs {
  display: flex;
  border-bottom: 1px solid #e5e7eb;
  background: #f9fafb;
}
.right-tab-btn {
  flex: 1;
  padding: 10px 0;
  background: none;
  border: none;
  border-bottom: 2px solid transparent;
  font-weight: 500;
  color: #2563eb;
  cursor: pointer;
  transition: border-color 0.2s, background 0.2s;
}
.right-tab-btn.active {
  border-bottom: 2px solid #2563eb;
  background: #fff;
  color: #1d4ed8;
}
.right-tab-pane {
  min-height: 200px;
}
</style>
<script>
function showRightTab(tab) {
  document.getElementById('tab-contact-details').classList.remove('active');
  document.getElementById('tab-activity-log').classList.remove('active');
  document.getElementById('right-contact-details').style.display = 'none';
  document.getElementById('right-activity-log').style.display = 'none';
  if (tab === 'contact-details') {
    document.getElementById('tab-contact-details').classList.add('active');
    document.getElementById('right-contact-details').style.display = 'block';
  } else {
    document.getElementById('tab-activity-log').classList.add('active');
    document.getElementById('right-activity-log').style.display = 'block';
  }
}
</script>

<div id="dripPopup" style="display:none;"></div>

{% endblock %}
