{% extends "base.html" %}
{% block content %}
<div class="property-account" style="display:flex;gap:0;">
    <div class="left-panel" style="width:70%;padding-right:2%;">
        <h2 style="margin-bottom:18px;">Property: {{ property.address }}{% if property.unit %} Unit {{ property.unit }}{% endif %}, {{ property.city }}, {{ property.state }} {{ property.zip }}</h2>
        <!-- Contact Card Grid -->
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
            <h3 style="margin:0;">Contacts</h3>
            <button onclick="showAddContactModal()" style="margin-left:auto;">+ Add Contact</button>
        </div>
        <div class="contact-card-grid">
            {% for contact in contacts %}
            <div class="contact-card">
                <div style="font-weight:600;font-size:15px;">{{ contact.first_name }} {{ contact.last_name }}</div>
                <div style="font-size:13px;color:#555;">{{ contact.type }}</div>
                <div style="font-size:13px;margin-top:4px;">Phones: {{ contact.phones|join(', ') }}</div>
                <div class="contact-actions">
                    <img src="/static/icons/call.svg" class="contact-action-icon" title="Call" onclick="callContact('{{ contact.phones[0] }}')">
                    <img src="/static/icons/text.svg" class="contact-action-icon" title="Text" onclick="textContact('{{ contact.phones[0] }}')">
                    <img src="/static/icons/email.svg" class="contact-action-icon" title="Email" onclick="emailContact('{{ contact.email }}')">
                </div>
            </div>
            {% endfor %}
        </div>
        <!-- Property Details Grid -->
        <div class="property-details-grid">
            <div class="property-detail-group">
                <h4>All Property Details</h4>
                {% for key, value in property.items() %}
                    {% if key not in ['id'] %}
                    <div class="property-detail-row">
                        <span class="property-detail-label">{{ key|replace('_', ' ')|title }}</span>
                        <span class="property-detail-value">{{ value }}</span>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="right-panel" style="width:30%;min-width:340px;">
        <h3>Activity Log</h3>
        <ul id="activity-log-list" class="activity-log-list">
            {% for log in activity_log %}
            <li>{{ log.timestamp }} - <strong>{{ log.activity_type }}</strong>: {{ log.details }} ({{ log.user }})</li>
            {% endfor %}
        </ul>
        <form id="addActivityLogForm">
            <input name="activity_type" placeholder="Type (e.g. Note, Edit)" required><br>
            <input name="details" placeholder="Details" required><br>
            <input name="user" placeholder="User" required><br>
            <button type="submit">Add Log</button>
        </form>
        <div class="sticky-notes-section">
            <textarea placeholder="Add notes for this property..."></textarea>
            <button>Save Note</button>
        </div>
    </div>
</div>
<script>
function showAddContactModal() {
    // Implement modal logic or reuse existing modal
}
function callContact(phone) {
    alert('Call ' + phone);
}
function textContact(phone) {
    alert('Text ' + phone);
}
function emailContact(email) {
    alert('Email ' + email);
}
document.getElementById('addActivityLogForm').onsubmit = function(e) {
    e.preventDefault();
    const form = e.target;
    const data = {
        property_id: {{ property.id }},
        activity_type: form.activity_type.value,
        details: form.details.value,
        user: form.user.value
    };
    fetch('/property_activity_log/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    }).then(r => r.json()).then(res => {
        if(res.success) {
            fetch(`/api/property_activity_log?property_id=${data.property_id}`)
                .then(r => r.json())
                .then(logs => {
                    const ul = document.getElementById('activity-log-list');
                    ul.innerHTML = '';
                    logs.forEach(log => {
                        const li = document.createElement('li');
                        li.innerHTML = `${log.timestamp} - <strong>${log.activity_type}</strong>: ${log.details} (${log.user})`;
                        ul.appendChild(li);
                    });
                });
            form.reset();
        }
    });
};
</script>
<script>
function showTab(tab) {
    document.getElementById('tab-lead').style.display = (tab === 'lead') ? 'block' : 'none';
    document.getElementById('tab-tasks').style.display = (tab === 'tasks') ? 'block' : 'none';
    document.getElementById('tab-portfolio').style.display = (tab === 'portfolio') ? 'block' : 'none';
}
document.getElementById('addActivityLogForm').onsubmit = function(e) {
    e.preventDefault();
    const form = e.target;
    const data = {
        property_id: {{ property.id }},
        activity_type: form.activity_type.value,
        details: form.details.value,
        user: form.user.value
    };
    fetch('/property_activity_log/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    }).then(r => r.json()).then(res => {
        if(res.success) {
            // Reload activity log
            fetch(`/api/property_activity_log?property_id=${data.property_id}`)
                .then(r => r.json())
                .then(logs => {
                    const ul = document.getElementById('activity-log-list');
                    ul.innerHTML = '';
                    logs.forEach(log => {
                        const li = document.createElement('li');
                        li.innerHTML = `${log.timestamp} - <strong>${log.activity_type}</strong>: ${log.details} (${log.user})`;
                        ul.appendChild(li);
                    });
                });
            form.reset();
        }
    });
};
</script>
{% endblock %}
