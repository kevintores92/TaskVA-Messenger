{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<header class="topbar">
  <div class="logo">SMS KPIs</div>
  <div class="actions">
    <button onclick="location.reload()" class="btn small">Refresh</button>
  </div>
</header>


<main class="dashboard-grid-main">
  <div class="dashboard-week-nav">
    <form method="get" id="weekNavForm" style="display:inline-block;">
      <label for="weekSelect" style="font-weight:500;margin-right:8px;">Week:</label>
      <select name="week" id="weekSelect" onchange="document.getElementById('weekNavForm').submit()" style="padding:6px 12px;font-size:1em;border-radius:6px;">
        {% for w in weeks %}
          <option value="{{ w }}" {% if w == selected_week %}selected{% endif %}>{{ w }}</option>
        {% endfor %}
      </select>
    </form>
  </div>
  <section class="dashboard-grid-cards">
    <div class="card small">
      <div class="card-title">Total Sent (last day)</div>
      <div class="card-value" id="totalSent">{{ latest.total_sent }}</div>
    </div>
    <div class="card small">
      <div class="card-title">Delivered</div>
      <div class="card-value" id="totalDelivered">{{ latest.total_delivered }}</div>
    </div>
    <div class="card small">
      <div class="card-title">Replies</div>
      <div class="card-value" id="totalReplies">{{ latest.total_replies }}</div>
    </div>
  </section>

  <section class="dashboard-grid-kpis">
    <div class="kpi-card">
      <h3 style="margin-bottom: 8px; display: flex; align-items: center;">Top 3 Campaigns <span style="font-size:14px;color:#bdbdbd;margin-left:6px;cursor:help;" title="Based on contact tags">&#9432;</span></h3>
      <div style="overflow-x:auto;">
      <table style="width:100%;background:transparent;border-collapse:separate;border-spacing:0 2px;">
        <thead>
          <tr style="font-size:15px;color:#888;font-weight:500;">
            <th style="text-align:left;padding:6px 0 6px 8px;">&nbsp;</th>
            <th style="text-align:center;"><span style="color:#d77b7b;font-size:18px;vertical-align:middle;">&#128293;</span></th>
            <th style="text-align:center;"><span style="color:#ffe082;font-size:18px;vertical-align:middle;">&#128165;</span></th>
            <th style="text-align:center;"><span style="color:#8bc34a;font-size:18px;vertical-align:middle;">&#127793;</span></th>
            <th style="text-align:center;"><span style="color:#5c6bc0;font-size:18px;vertical-align:middle;">&#128167;</span></th>
          </tr>
        </thead>
        <tbody>
        {% for camp in top_campaigns %}
          <tr style="background:{{ loop.index0 % 2 == 1 and '#f7f8fa' or 'transparent' }};font-size:16px;">
            <td style="padding:8px 0 8px 8px;max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">{{ camp.name }}</td>
            <td style="text-align:center;font-weight:500;">{{ camp.Hot }}</td>
            <td style="text-align:center;font-weight:500;">{{ camp.Warm }}</td>
            <td style="text-align:center;font-weight:500;">{{ camp.Nurture }}</td>
            <td style="text-align:center;font-weight:500;">{{ camp.Drip }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      </div>
    </div>
    <div class="kpi-card">
      <h3 style="margin-bottom: 8px;">Lead Breakdown</h3>
      <div style="display: flex; align-items: center;justify-content:center;">
        <canvas id="leadBreakdownChart" width="160" height="160" style="max-width:160px;max-height:160px;"></canvas>
        <div style="margin-left: 24px;">
          <div style="margin-bottom: 8px;"><span style="display:inline-block;width:14px;height:14px;background:#d77b7b;border-radius:3px;margin-right:8px;"></span>Hot Leads: {{ lead_breakdown['Hot Leads'] }}</div>
          <div style="margin-bottom: 8px;"><span style="display:inline-block;width:14px;height:14px;background:#8bc34a;border-radius:3px;margin-right:8px;"></span>Nurture: {{ lead_breakdown['Nurture'] }}</div>
          <div style="margin-bottom: 8px;"><span style="display:inline-block;width:14px;height:14px;background:#5c6bc0;border-radius:3px;margin-right:8px;"></span>Drips: {{ lead_breakdown['Drips'] }}</div>
          <div style="margin-top:12px;font-weight:bold;">Total: {{ lead_breakdown['total'] }}</div>
        </div>
      </div>
    </div>
  </section>
  <section class="dashboard-grid-charts">
    <div class="chart-card">
      <h3>Messages Sent / Delivered (by day)</h3>
      <canvas id="sentDeliveredChart" width="340" height="180"></canvas>
    </div>
    <div class="chart-card">
      <h3>Delivery Rate % (by day)</h3>
      <canvas id="deliveryRateChart" width="340" height="180"></canvas>
    </div>
    <div class="chart-card">
      <h3>Replies (by day)</h3>
      <canvas id="repliesChart" width="340" height="180"></canvas>
    </div>
    <div class="chart-card">
      <h3>Sent / Replies (last 30 days)</h3>
      <canvas id="lineChart" width="340" height="180"></canvas>
    </div>
  </section>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const dates = {{ dates|tojson }};
const sent = {{ sent|tojson }};
const delivered = {{ delivered|tojson }};
const delivery_rate = {{ delivery_rate|tojson }};
const replies = {{ replies|tojson }};

// Lead Breakdown Donut
const leadBreakdownData = {
  labels: [
    'Hot Leads',
    'Warm Leads',
    'Nurture',
    'Drips',
    'No Status'
  ],
  datasets: [{
    data: [
      {{ lead_breakdown['Hot Leads'] }},
      {{ lead_breakdown['Warm Leads'] }},
      {{ lead_breakdown['Nurture'] }},
      {{ lead_breakdown['Drips'] }},
      {{ lead_breakdown['No Status'] }}
    ],
    backgroundColor: [
      '#d77b7b', // Hot
      '#ffe082', // Warm
      '#8bc34a', // Nurture
      '#5c6bc0', // Drips
      '#e0e0e0'  // No Status
    ],
    borderWidth: 1
  }]
};
new Chart(document.getElementById('leadBreakdownChart'), {
  type: 'doughnut',
  data: leadBreakdownData,
  options: {
    cutout: '70%',
    plugins: {
      legend: { display: false },
      tooltip: { enabled: true }
    }
  }
});

// Sent / Delivered (line)
new Chart(document.getElementById('sentDeliveredChart'), {
  type: 'line',
  data: {
    labels: dates,
    datasets: [
      {
        label: 'Sent',
        data: sent,
        fill: false,
        borderWidth: 2
      },
      {
        label: 'Delivered',
        data: delivered,
        fill: false,
        borderWidth: 2
      }
    ]
  },
  options: { responsive: true, maintainAspectRatio: false, aspectRatio: 1.8 }
});

// Delivery rate (bar)
new Chart(document.getElementById('deliveryRateChart'), {
  type: 'bar',
  data: { labels: dates, datasets: [{ label: 'Delivery Rate %', data: delivery_rate }] },
  options: { responsive: true, maintainAspectRatio: false, aspectRatio: 1.8 }
});

// Replies (bar)
new Chart(document.getElementById('repliesChart'), {
  type: 'bar',
  data: { labels: dates, datasets: [{ label: 'Replies', data: replies }] },
  options: { responsive: true, maintainAspectRatio: false, aspectRatio: 2.2 }
});

// Line chart last 30 days
new Chart(document.getElementById('lineChart'), {
  type: 'line',
  data: { labels: dates, datasets: [{ label: 'Sent', data: sent }, { label: 'Replies', data: replies }] },
  options: { responsive: true, maintainAspectRatio: false, aspectRatio: 1.8 }
});
</script>
{% endblock %}
