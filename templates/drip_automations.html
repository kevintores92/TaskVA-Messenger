{% extends "base.html" %}
{% block content %}
<div style="margin: 40px auto 0 auto; max-width: 1200px; min-width: 700px; background: #fff; border-radius: 14px; box-shadow: 0 2px 16px #0001; padding: 36px 48px;">
  <div class="page-header">
    <h2>üìã Drip Automations</h2>
    <a href="{{ url_for('new_drip_automation') }}" class="btn btn-primary" style="float:right; margin-top:-40px;">‚ûï New Drip</a>
  </div>
  <table class="drip-table">
    <thead>
      <tr>
        <th>Name</th>
        <th>Messages</th>
        <th>Days</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for drip in automations|groupby('id') %}
        <tr class="drip-row" data-drip-id="{{ drip.list[0].id }}">
          <td>
            <span class="drip-name">{{ drip.list[0].name }}</span>
            <button class="show-messages-btn" onclick="toggleDripMessages({{ drip.list[0].id }})">Show More</button>
          </td>
          <td>{{ drip.list|length }}</td>
          <td>{{ drip.list|map(attribute='day_offset')|join(', ') }}</td>
          <td>
            <a href="{{ url_for('edit_drip_automation', drip_id=drip.list[0].id) }}" class="btn btn-secondary">‚úèÔ∏è Edit</a>
            <form method="POST" action="{{ url_for('delete_drip_automation', drip_id=drip.list[0].id) }}" style="display:inline;">
              <button type="submit" class="btn btn-danger" onclick="return confirm('Delete this drip automation?')">üóëÔ∏è Delete</button>
            </form>
          </td>
        </tr>
        <tr class="drip-messages-row" id="drip-messages-{{ drip.list[0].id }}" style="display:none;">
          <td colspan="4">
            <div class="drip-messages-expand">
              {% for msg in drip.list %}
                <div style="margin-bottom:12px;">
                  <b>Day {{ msg.day_offset }}</b>: {{ msg.message_template }}
                </div>
              {% endfor %}
            </div>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<style>
.drip-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  margin-top: 30px;
  background: #fff;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 1px 8px #0001;
}
.drip-table th, .drip-table td {
  border-bottom: 1px solid #eee;
  padding: 16px 18px;
  text-align: left;
  font-size: 1.08em;
}
.drip-table th {
  background: #f5f5f5;
  font-size: 1.12em;
}
.btn-primary {
  background: #2196f3;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 10px 18px;
  cursor: pointer;
  text-decoration: none;
}
.btn-secondary {
  background: #4CAF50;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 14px;
  cursor: pointer;
  text-decoration: none;
}
.btn-danger {
  background: #ff4d4f;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 14px;
  cursor: pointer;
}
</style>
<script>
function toggleDripMessages(dripId) {
  var row = document.getElementById('drip-messages-' + dripId);
  var btn = document.querySelector('.drip-row[data-drip-id="' + dripId + '"] .show-messages-btn');
  if (row.style.display === 'none') {
    row.style.display = '';
    btn.textContent = 'Show Less';
  } else {
    row.style.display = 'none';
    btn.textContent = 'Show More';
  }
}
</script>
{% endblock %}
