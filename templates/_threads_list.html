{% for thread in threads %}
  <div class="thread card{% if selected_phone == thread.phone %} selected{% endif %}" 
       id="thread-{{ thread.phone | replace('+','plus') }}" 
       onclick="if(!event.target.closest('.thread-tag-wrapper')) loadThread('{{ thread.phone }}')">

    <div class="thread-info">
      <div class="thread-name">
        <b class="thread-name-label">
          {% if thread.name %}{{ thread.name }}{% else %}{{ thread.phone }}{% endif %}
        </b>
        <span class="thread-phone" style="display:none;">{{ thread.phone }}</span>

        {# --- 🔴 Unread indicator --- #}
        {% if thread.unread %}
          <span class="unread-badge" style="color:red; margin-left:6px;">●</span>
        {% endif %}

        <span class="thread-tag-wrapper">
          {# Show only one Drip chip for any Drip tag #}
          {% set drip_name = None %}
          {% if thread.tag and thread.tag.startswith('Drip - ') %}
            {% set drip_name = thread.tag[7:] %}
          {% endif %}
          <span class="chip drip-chip"
                data-phone="{{ thread.phone }}"
                data-tag="{{ thread.tag or 'No tag' }}"
                {% if drip_name %}data-tooltip="{{ drip_name }}" title="{{ drip_name }}"{% else %}title="{{ thread.tag or 'No tag' }}"{% endif %}>
            {% if drip_name %}Drip{% else %}{{ tag_icons.get(thread.tag or 'No tag', '🏷️') }}{% endif %}
          </span>
          <span class="tag-menu">
            {% for tag in tags %}
              <span class="tag-option"
                    data-tag="{{ tag }}"
                    title="{{ tag }}">
                {{ tag_icons.get(tag, '🏷️') }}
              </span>
            {% endfor %}
          </span>

        {% if thread.notes and thread.notes|trim %}
          <span class="note-icon">&#128221;
            <span class="note-tooltip">{{ thread.notes }}</span>
          </span>
        {% endif %}
        
      </div>
      <div class="thread-preview thread-body">{{ thread.latest | replace('\n', '<br>') | safe }}</div>
    </div>

    <div class="thread-actions">
      <div class="thread-time">{{ thread.timestamp }}</div>
      <div><input type="checkbox" class="thread-checkbox" data-phone="{{ thread.phone }}" onclick="event.stopPropagation();">
      <button class="btn btn-sm" onclick="event.stopPropagation(); callContact('{{ thread.phone }}')">📞</button></div>
    </div>
  </div>
{% endfor %}
